# Reporte de Pruebas de Tipos de Usuario - search_units MCP TrackHS

**Fecha:** 22 de Octubre de 2025
**Componente:** search_units (MCP TrackHS)
**Versi√≥n API:** Channel API

---

## Resumen Ejecutivo

Se realizaron pruebas exhaustivas de la funci√≥n `search_units` del MCP TrackHS para validar su comportamiento con diferentes tipos de usuarios y par√°metros. Se identific√≥ un **problema cr√≠tico** de validaci√≥n de tipos que impide el uso de filtros num√©ricos y booleanos.

### Estad√≠sticas
- ‚úÖ **Escenarios exitosos:** 2 de 6 (33%)
- ‚ùå **Escenarios fallidos:** 4 de 6 (67%)
- üî¥ **Gravedad:** Alta - Impacta a todos los tipos de usuarios

---

## Problema Principal

**Inconsistencia en validaci√≥n de tipos de par√°metros:**

El schema MCP define par√°metros num√©ricos y booleanos como `Optional[str]` en el c√≥digo Python, pero el servidor FastMCP los valida como `integer`, causando errores de tipo cuando los usuarios intentan usar estos filtros.

```python
# Definici√≥n en el c√≥digo (search_units.py)
bedrooms: Optional[str] = Field(
    default=None,
    description="Filter by exact number of bedrooms"
)

# Error generado por el servidor
"Parameter 'bedrooms' must be one of types [integer, null], got string"
```

---

## Escenarios de Prueba

### ‚úÖ Escenario 1: Usuario B√°sico - B√∫squeda Simple
**Tipo de usuario:** Turista
**Objetivo:** Buscar propiedades por nombre

**Par√°metros:**
```python
{
    "page": 1,
    "size": 3,
    "search": "villa"
}
```

**Resultado:** ‚úÖ **EXITOSO**
**Respuesta:** Retorna 20 unidades tipo "villa" correctamente

**Datos retornados:**
- 5 Bedroom luxury villa by Disney-332
- 6 Bedroom luxury villa by Disney-316
- 6 bedrooms Villa close to Disney Parks-312

---

### ‚ùå Escenario 2: Usuario Avanzado - Filtros de Caracter√≠sticas
**Tipo de usuario:** Familia
**Objetivo:** Buscar propiedades con n√∫mero espec√≠fico de habitaciones y ba√±os

**Par√°metros:**
```python
{
    "page": 1,
    "size": 3,
    "bedrooms": "4",  # String
    "bathrooms": "2"  # String
}
```

**Resultado:** ‚ùå **FALLIDO**
**Error:** `Parameter 'bedrooms' must be one of types [integer, null], got string`

**Impacto:** Familias no pueden filtrar por caracter√≠sticas f√≠sicas de las propiedades

---

### ‚ùå Escenario 3: Usuario con Preferencias - Filtros Booleanos
**Tipo de usuario:** Due√±o de mascotas
**Objetivo:** Buscar propiedades pet-friendly que est√©n activas

**Par√°metros:**
```python
{
    "page": 1,
    "size": 3,
    "pets_friendly": "1",  # String representando boolean
    "is_active": "1"       # String representando boolean
}
```

**Resultado:** ‚ùå **FALLIDO**
**Error:** `Parameter 'pets_friendly' must be one of types [integer, null], got string`

**Impacto:** Due√±os de mascotas no pueden filtrar propiedades adecuadas

---

### ‚úÖ Escenario 4: Usuario por Ubicaci√≥n
**Tipo de usuario:** Turista local
**Objetivo:** Buscar propiedades en una ubicaci√≥n espec√≠fica

**Par√°metros:**
```python
{
    "page": 1,
    "size": 3,
    "node_id": "3",  # String (acepta correctamente)
    "search": "Champions Gate"
}
```

**Resultado:** ‚úÖ **EXITOSO**
**Nota:** Los par√°metros de ID (node_id, amenity_id, unit_type_id) s√≠ aceptan strings correctamente

---

### ‚ùå Escenario 5: Usuario Buscando Disponibilidad
**Tipo de usuario:** Planificador de viajes
**Objetivo:** Buscar propiedades disponibles en fechas espec√≠ficas

**Par√°metros:**
```python
{
    "page": 1,
    "size": 3,
    "arrival": "2025-11-01",
    "departure": "2025-11-07",
    "is_bookable": "1"  # String representando boolean
}
```

**Resultado:** ‚ùå **FALLIDO**
**Error:** `Parameter 'is_bookable' must be one of types [integer, null], got string`

**Impacto:** Usuarios no pueden filtrar por disponibilidad para reserva

---

### ‚ùå Escenario 6: Usuario con Rango de Habitaciones
**Tipo de usuario:** Grupo grande
**Objetivo:** Buscar propiedades con rango de habitaciones

**Par√°metros:**
```python
{
    "page": 1,
    "size": 3,
    "min_bedrooms": "3",  # String
    "max_bedrooms": "6"   # String
}
```

**Resultado:** ‚ùå **FALLIDO**
**Error:** `Parameter 'min_bedrooms' must be one of types [integer, null], got string`

**Impacto:** Grupos grandes no pueden buscar propiedades adecuadas a su tama√±o

---

## An√°lisis T√©cnico Detallado

### Causa Ra√≠z
Existe una **discrepancia** entre:
1. **Definici√≥n del schema** en el c√≥digo Python (acepta `Optional[str]`)
2. **Validaci√≥n del servidor** FastMCP (requiere `integer`)

### Par√°metros Afectados

#### Par√°metros Num√©ricos (8 par√°metros):
- `bedrooms` - N√∫mero exacto de habitaciones
- `min_bedrooms` - M√≠nimo de habitaciones
- `max_bedrooms` - M√°ximo de habitaciones
- `bathrooms` - N√∫mero exacto de ba√±os
- `min_bathrooms` - M√≠nimo de ba√±os
- `max_bathrooms` - M√°ximo de ba√±os
- `calendar_id` - ID de calendario
- `role_id` - ID de rol

#### Par√°metros Booleanos/Binarios (12 par√°metros):
- `pets_friendly` - Acepta mascotas (0/1)
- `allow_unit_rates` - Permite tarifas por unidad (0/1)
- `computed` - Unidad computada (0/1)
- `inherited` - Unidad heredada (0/1)
- `limited` - Disponibilidad limitada (0/1)
- `is_bookable` - Es reservable (0/1)
- `include_descriptions` - Incluir descripciones (0/1)
- `is_active` - Est√° activa (0/1)
- `events_allowed` - Permite eventos (0/1)
- `smoking_allowed` - Permite fumar (0/1)
- `children_allowed` - Permite ni√±os (0/1)
- `is_accessible` - Es accesible (0/1)

#### Par√°metros que S√ç funcionan correctamente (4 par√°metros):
- `node_id` - ID de nodo
- `amenity_id` - ID de amenidad
- `unit_type_id` - ID de tipo de unidad
- `id` - ID de unidad

---

## Casos de Uso Bloqueados

### üî¥ Gravedad Cr√≠tica
**Filtrado por unidades activas/disponibles**
- Par√°metros afectados: `is_active`, `is_bookable`
- Usuarios afectados: **Todos los usuarios**
- Descripci√≥n: No se pueden filtrar unidades que est√©n actualmente disponibles para reserva

### üü† Gravedad Alta
**Filtrado por n√∫mero de habitaciones**
- Par√°metros afectados: `bedrooms`, `min_bedrooms`, `max_bedrooms`, `bathrooms`
- Usuarios afectados: Familias, grupos grandes
- Descripci√≥n: Caracter√≠stica fundamental para encontrar alojamiento adecuado

**Filtrado por propiedades pet-friendly**
- Par√°metros afectados: `pets_friendly`
- Usuarios afectados: Due√±os de mascotas
- Descripci√≥n: Criterio importante para viajeros con mascotas

### üü° Gravedad Media
**Filtrado por rangos de caracter√≠sticas**
- Par√°metros afectados: `min_bedrooms`, `max_bedrooms`, `min_bathrooms`, `max_bathrooms`
- Usuarios afectados: Usuarios avanzados
- Descripci√≥n: Limita las opciones de b√∫squeda flexible

---

## Pruebas Exitosas Realizadas

### B√∫squeda B√°sica por Texto
```python
# Llamada MCP
mcp_ihmTrackhs_search_units(
    page=1,
    size=3,
    search="villa"
)

# Resultado: ‚úÖ Exitoso
# Retorna 20 unidades con "villa" en el nombre
```

### B√∫squeda por Ubicaci√≥n (Node ID)
```python
# Llamada MCP
mcp_ihmTrackhs_search_units(
    page=1,
    size=3,
    node_id="3",
    search="Champions Gate"
)

# Resultado: ‚úÖ Exitoso
# Los par√°metros de ID funcionan correctamente con strings
```

---

## Comparaci√≥n: C√≥digo vs Servidor

### En el C√≥digo Python (search_units.py)
```python
bedrooms: Optional[str] = Field(
    default=None,
    description="Filter by exact number of bedrooms"
)

pets_friendly: Optional[str] = Field(
    default=None,
    description="Filter by pet-friendly units (0=no, 1=yes)"
)
```

### En el Servidor FastMCP
```
Parameter 'bedrooms' must be one of types [integer, null], got string
Parameter 'pets_friendly' must be one of types [integer, null], got string
```

### Problema
El servidor **sobrescribe** la definici√≥n del schema y aplica validaci√≥n estricta de tipos incompatible con la API de TrackHS.

---

## Recomendaciones

### üî¥ Prioridad Alta

#### 1. Actualizar el Schema MCP para Union Types
**Acci√≥n:** Cambiar los tipos de par√°metros num√©ricos y booleanos para aceptar tanto `string` como `integer`

```python
# Antes
bedrooms: Optional[str] = Field(...)

# Despu√©s
bedrooms: Optional[Union[str, int]] = Field(...)
```

**Justificaci√≥n:** Permite compatibilidad con diferentes clientes MCP y con la forma en que la API de TrackHS espera los par√°metros

**Archivos a modificar:**
- `src/trackhs_mcp/infrastructure/mcp/search_units.py`

#### 2. Implementar Normalizaci√≥n de Tipos
**Acci√≥n:** Agregar conversi√≥n autom√°tica de strings a integers en el procesamiento de par√°metros

```python
def normalize_numeric_param(value: Optional[Union[str, int]]) -> Optional[int]:
    if value is None:
        return None
    if isinstance(value, str):
        try:
            return int(value)
        except ValueError:
            return None
    return value
```

**Justificaci√≥n:** Convierte autom√°ticamente los tipos sin generar errores, mejorando la experiencia del usuario

**Archivos a modificar:**
- `src/trackhs_mcp/infrastructure/utils/type_normalization.py` (ya existe)
- `src/trackhs_mcp/infrastructure/mcp/search_units.py` (aplicar normalizaci√≥n)

### üü† Prioridad Media

#### 3. Documentar Tipos Esperados
**Acci√≥n:** Actualizar las descripciones de par√°metros para indicar expl√≠citamente los tipos aceptados

```python
bedrooms: Optional[Union[str, int]] = Field(
    default=None,
    description="Filter by exact number of bedrooms (accepts string or integer)"
)
```

**Justificaci√≥n:** Ayuda a los desarrolladores a entender los requisitos sin consultar el c√≥digo fuente

### üü¢ Prioridad Baja

#### 4. Mejorar Mensajes de Error
**Acci√≥n:** Proporcionar mensajes de error m√°s descriptivos que gu√≠en al usuario

```python
try:
    # validaci√≥n
except ValidationError as e:
    raise ValidationError(
        f"Parameter '{param_name}' expects integer or string representation "
        f"of integer. Got: {type(value).__name__}"
    )
```

---

## Impacto en Usuarios

### Tipos de Usuario Afectados

| Tipo de Usuario | Funcionalidad Bloqueada | Impacto |
|-----------------|------------------------|---------|
| **Turistas** | B√∫squeda b√°sica | ‚úÖ Funciona |
| **Familias** | Filtro por habitaciones/ba√±os | ‚ùå Bloqueado |
| **Due√±os de mascotas** | Filtro pet-friendly | ‚ùå Bloqueado |
| **Grupos grandes** | Rangos de caracter√≠sticas | ‚ùå Bloqueado |
| **Planificadores** | Filtro por disponibilidad | ‚ùå Bloqueado |
| **Usuarios avanzados** | Filtros m√∫ltiples | ‚ùå Bloqueado |

### Porcentaje de Funcionalidad Disponible
- **B√∫squedas b√°sicas:** 100% funcional
- **Filtros de ID:** 100% funcional
- **Filtros num√©ricos:** 0% funcional ‚ùå
- **Filtros booleanos:** 0% funcional ‚ùå
- **Filtros de fecha:** 100% funcional
- **Funcionalidad total:** ~40% operativa

---

## Ejemplo de Implementaci√≥n de la Soluci√≥n

### Soluci√≥n Propuesta en search_units.py

```python
from typing import Union

# 1. Cambiar definiciones de tipos
bedrooms: Optional[Union[str, int]] = Field(
    default=None,
    description="Filter by exact number of bedrooms (integer or string)"
)

pets_friendly: Optional[Union[str, int]] = Field(
    default=None,
    description="Filter by pet-friendly units (0=no, 1=yes, integer or string)"
)

# 2. Aplicar normalizaci√≥n antes de crear SearchUnitsParams
normalized_params = {
    "bedrooms": normalize_int(bedrooms),
    "pets_friendly": normalize_binary_int(pets_friendly),
    # ... otros par√°metros
}

# 3. Crear entidad con valores normalizados
params = SearchUnitsParams(**normalized_params)
```

### Funciones de Normalizaci√≥n Ya Disponibles

El proyecto ya cuenta con funciones de normalizaci√≥n en:
`src/trackhs_mcp/infrastructure/utils/type_normalization.py`

```python
def normalize_int(value: Optional[Union[str, int, float]]) -> Optional[int]:
    """Normaliza un valor a entero"""
    # Implementaci√≥n existente

def normalize_binary_int(value: Optional[Union[str, int]]) -> Optional[int]:
    """Normaliza un valor binario (0/1)"""
    # Implementaci√≥n existente
```

---

## Conclusiones

### Hallazgos Principales

1. **Problema Identificado:** Validaci√≥n de tipos demasiado estricta en el servidor FastMCP
2. **Alcance del Problema:** 20 de 35 par√°metros afectados (57%)
3. **Gravedad:** Alta - Impide el uso de funcionalidades cr√≠ticas
4. **Soluci√≥n:** Factible y bien definida

### Estado Actual del MCP
- ‚úÖ **Funcional:** B√∫squedas b√°sicas por texto y filtros de ID
- ‚ùå **No funcional:** Filtros num√©ricos y booleanos
- ‚ö†Ô∏è **Limitado:** Solo 40% de la funcionalidad disponible

### Pr√≥ximos Pasos Recomendados

1. Implementar Union types en definiciones de par√°metros
2. Aplicar normalizaci√≥n de tipos antes de validaci√≥n
3. Ejecutar suite de pruebas completa
4. Validar con usuarios reales
5. Documentar cambios y actualizaciones

---

## Archivos de Referencia

- **Script de pruebas:** `test_search_units_user_types.py`
- **Reporte JSON:** `reporte_pruebas_tipos_search_units.json`
- **C√≥digo fuente:** `src/trackhs_mcp/infrastructure/mcp/search_units.py`
- **Utilidades:** `src/trackhs_mcp/infrastructure/utils/type_normalization.py`

---

## Anexos

### Anexo A: Lista Completa de Par√°metros search_units

#### Paginaci√≥n (2)
- `page` - N√∫mero de p√°gina ‚úÖ
- `size` - Tama√±o de p√°gina ‚úÖ

#### Ordenamiento (2)
- `sort_column` - Columna de ordenamiento ‚úÖ
- `sort_direction` - Direcci√≥n de ordenamiento ‚úÖ

#### B√∫squeda de texto (4)
- `search` - B√∫squeda completa ‚úÖ
- `term` - T√©rmino de b√∫squeda ‚úÖ
- `unit_code` - C√≥digo de unidad ‚úÖ
- `short_name` - Nombre corto ‚úÖ

#### Filtros de ID (4)
- `node_id` - ID de nodo ‚úÖ
- `amenity_id` - ID de amenidad ‚úÖ
- `unit_type_id` - ID de tipo ‚úÖ
- `id` - ID de unidad ‚úÖ

#### Filtros num√©ricos (8)
- `bedrooms` - Habitaciones ‚ùå
- `min_bedrooms` - M√≠nimo habitaciones ‚ùå
- `max_bedrooms` - M√°ximo habitaciones ‚ùå
- `bathrooms` - Ba√±os ‚ùå
- `min_bathrooms` - M√≠nimo ba√±os ‚ùå
- `max_bathrooms` - M√°ximo ba√±os ‚ùå
- `calendar_id` - ID calendario ‚ùå
- `role_id` - ID rol ‚ùå

#### Filtros booleanos (12)
- `pets_friendly` - Mascotas ‚ùå
- `allow_unit_rates` - Tarifas unidad ‚ùå
- `computed` - Computada ‚ùå
- `inherited` - Heredada ‚ùå
- `limited` - Limitada ‚ùå
- `is_bookable` - Reservable ‚ùå
- `include_descriptions` - Descripciones ‚ùå
- `is_active` - Activa ‚ùå
- `events_allowed` - Eventos ‚ùå
- `smoking_allowed` - Fumar ‚ùå
- `children_allowed` - Ni√±os ‚ùå
- `is_accessible` - Accesible ‚ùå

#### Filtros de fecha (4)
- `arrival` - Fecha llegada ‚úÖ
- `departure` - Fecha salida ‚úÖ
- `content_updated_since` - Contenido actualizado ‚úÖ
- `updated_since` - Actualizado desde ‚úÖ

#### Estado (1)
- `unit_status` - Estado limpieza ‚úÖ

**Total:** 37 par√°metros
**Funcionales:** 17 (46%)
**No funcionales:** 20 (54%)

---

**Fin del Reporte**

*Generado el 22 de Octubre de 2025*
*MCPtrackhsConnector - TrackHS API Integration*

